<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3448/3448636.png" type="image/png">
    <title>ğŸš– Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ§ÙƒØ³ÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Chakra+Petch:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">

    <style>
        :root {
            --font-main: 'Cairo', sans-serif;
            --font-digital: 'Chakra Petch', sans-serif;
            --bg-navy: #3269e7; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø¨Ø­Ø±ÙŠ */
        }
        
        body { 
            font-family: var(--font-main); 
            background-color: var(--bg-navy); 
            color: white;
        }
        
        .digital-font { font-family: var(--font-digital); }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù„ÙˆÙ†Ø© */
        .stat-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 240px;
            background: white; /* ØªØ¨Ø§ÙŠÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø¹ Ø§Ù„Ø®Ù„ÙÙŠØ© */
            color: #1e293b;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ */
        .glass-table {
            background: rgb(0, 0, 0);
            border-radius: 2.5rem;
            overflow: hidden;
            color: #1e293b;
        }

        /* Snackbar */
        #snackbar {
            visibility: hidden; min-width: 280px; background-color: #1e293b;
            color: #fff; text-align: center; border-radius: 16px; padding: 20px;
            position: fixed; z-index: 100; right: 30px; bottom: 30px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 15);
            border-bottom: 4px solid #facc15;
        }
        #snackbar.show { visibility: visible; animation: slideIn 0.5s, slideOut 0.5s 3.5s; }
        @keyframes slideIn { from {right: -300px; opacity: 0;} to {right: 30px; opacity: 1;} }
        @keyframes slideOut { from {right: 30px; opacity: 1;} to {right: -300px; opacity: 0;} }
    </style>
</head>
<body class="min-h-screen">

    <main class="p-4 md:p-8 pt-24 max-w-7xl mx-auto transition-all duration-300">
        
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
            <div>
                <h2 class="text-3xl font-black text-white tracking-tight">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø°ÙƒÙŠØ©</h2>
                <p class="text-slate-400 mt-1 uppercase text-[16px] tracking-[0.2em] font-bold italic">Smart Dashboard Control</p>
            </div>
            <div class="bg-white/10 backdrop-blur-md px-5 py-2 rounded-2xl border border-white/20 flex items-center gap-3 text-sm font-bold">
                <span id="connectionStatus" class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></span>
                <span id="statusText" class="text-white font-mono">Ù…ØªØµÙ„</span>
                <span class="text-white/30">|</span>
                <span id="currentDate" class="text-white font-mono bold"></span>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12">
            
            <div class="stat-card p-8 rounded-[2.5rem] shadow-2xl border-b-8 border-[#FFD700] group transition-all hover:-translate-y-2">
                <div class="p-4 bg-[#FFD700]/10 text-[#FFD700] rounded-3xl mb-4"><i class="fa-solid fa-calculator text-3xl"></i></div>
                <p class="text-slate-500 text-sm font-bold mb-2 uppercase tracking-wide">Ø§Ù„ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…ÙØªØ±Ø¶</p>
                <h3 class="text-6xl font-bold digital-font text-[#FFD700]" id="totalRevenue">0.00</h3>
            </div>

            <div class="stat-card p-8 rounded-[2.5rem] shadow-2xl border-b-8 border-[#8B0000] group transition-all hover:-translate-y-2">
                <div class="p-4 bg-[#8B0000]/10 text-[#8B0000] rounded-3xl mb-4"><i class="fa-solid fa-wrench text-3xl"></i></div>
                <p class="text-slate-500 text-sm font-bold mb-2 uppercase tracking-wide">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</p>
                <h3 class="text-6xl font-bold digital-font text-[#8B0000]" id="totalExpenses">0.00</h3>
            </div>

            <div class="stat-card p-8 rounded-[2.5rem] shadow-2xl border-b-8 border-[#388E3C] group transition-all hover:-translate-y-2">
                <div class="p-4 bg-[#388E3C]/10 text-[#388E3C] rounded-3xl mb-4"><i class="fa-solid fa-vault text-3xl"></i></div>
                <p class="text-slate-500 text-sm font-bold mb-2 uppercase tracking-wide">Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶ Ø§Ù„ÙØ¹Ù„ÙŠ</p>
                <h3 class="text-6xl font-bold digital-font text-[#388E3C]" id="totalCollected">0.00</h3>
            </div>

            <div class="stat-card p-8 rounded-[2.5rem] shadow-2xl border-b-8 border-[#F57C00] group transition-all hover:-translate-y-2">
                <div class="p-4 bg-[#F57C00]/10 text-[#F57C00] rounded-3xl mb-4"><i class="fa-solid fa-hand-holding-dollar text-3xl"></i></div>
                <p class="text-slate-500 text-sm font-bold mb-2 uppercase tracking-wide">ØµØ§ÙÙŠ Ø§Ù„Ø°Ù…Ù…</p>
                <h3 class="text-6xl font-bold digital-font text-[#F57C00]" id="netReceivables">0.00</h3>
            </div>

        </div>

        <div class="glass-table shadow-xl mb-8 rounded-2xl overflow-hidden border border-white/10 bg-gradient-to-br from-slate-800 via-slate-900 to-indigo-950">
            
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/5 backdrop-blur-sm">
                <h3 class="font-bold text-white text-2xl flex items-center gap-3">
                    <i class="fa-solid fa-car-side text-emerald-400 opacity-80"></i> 
                    Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„
                </h3>
                <div class="bg-red-500/10 text-red-400 border border-red-500/30 px-5 py-2 rounded-xl text-lg font-bold">
                    Ù…ØªÙˆÙ‚ÙØ©: <span id="idleCars" class="text-xl">0</span>
                </div>
            </div>

            <div class="overflow-x-auto px-4 pb-6">
                <table class="w-full text-right border-collapse">
                    <thead>
                        <tr class="text-slate-400 text-sm uppercase tracking-wider border-b border-white/5">
                            <th class="p-5 font-medium">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                            <th class="p-5 font-medium">Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
                            <th class="p-5 font-medium">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th class="p-5 text-center font-medium">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="fleetTableBody" class="text-slate-200 text-base font-normal">
                        <tr class="hover:bg-white/5 transition-colors">
                            <td colspan="4" class="p-12 text-center text-slate-400 animate-pulse">
                                <i class="fa-solid fa-cloud-arrow-down ml-2"></i>
                                Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø§Ù„Ø°ÙƒÙŠØ©...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="snackbar">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ§ÙƒØ³ÙŠ Ø§Ù„Ø°ÙƒÙŠ v1.3.0 Ø¬Ø§Ù‡Ø² ğŸš–</div>

    <script src="sidebar.js"></script>
    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase
        const SUPABASE_URL = 'https://tjntctaapsdynbywdfns.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_BJgdmxyFsCgzFDXh1Qn1CQ_cFRMsy2P';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function showSnackbar() {
            const sb = document.getElementById("snackbar");
            sb.className = "show";
            setTimeout(() => { sb.className = sb.className.replace("show", ""); }, 4000);
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        function updateOnlineStatus() {
            const statusCircle = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (navigator.onLine) {
                statusCircle.className = "w-3 h-3 rounded-full bg-green-500 animate-pulse";
                statusText.innerText = "Ù…ØªØµÙ„";
                statusText.className = "text-white font-mono";
            } else {
                statusCircle.className = "w-3 h-3 rounded-full bg-red-500";
                statusText.innerText = "ØºÙŠØ± Ù…ØªØµÙ„";
                statusText.className = "text-red-500 font-mono";
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        async function initializeDashboard() {
            updateOnlineStatus(); // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
            try {
                // ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('currentDate').innerText = new Date().toLocaleDateString('ar-EG', options);
                showSnackbar();

                // 1. Ø§Ù„ÙˆØ§Ø±Ø¯
                const { data: workDays } = await supabaseClient.from('work_days').select('daily_rent');
                const totalRev = workDays ? workDays.reduce((s, d) => s + Number(d.daily_rent || 0), 0) : 0;
                document.getElementById('totalRevenue').innerText = totalRev.toLocaleString();

                // 2. Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶
                const { data: revenues } = await supabaseClient.from('revenues').select('amount');
                const totalColl = revenues ? revenues.reduce((s, r) => s + Number(r.amount || 0), 0) : 0;
                document.getElementById('totalCollected').innerText = totalColl.toLocaleString();

                // 3. Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
                const { data: expenses } = await supabaseClient.from('expenses').select('total_amount');
                const totalExp = expenses ? expenses.reduce((s, e) => s + Number(e.total_amount || 0), 0) : 0;
                document.getElementById('totalExpenses').innerText = totalExp.toLocaleString();

                // 4. ØµØ§ÙÙŠ Ø§Ù„Ø°Ù…Ù…
                document.getElementById('netReceivables').innerText = (totalRev - totalColl).toLocaleString();

                await fetchFleetStatus();
            } catch (err) { console.error(err); }
        }

        async function fetchFleetStatus() {
            const tableBody = document.getElementById('fleetTableBody');
            const { data: cars, error } = await supabaseClient.from('cars').select(`
                plate_no, brand,
                handover ( event_type, handover_date, drivers ( name ) )
            `).order('plate_no');

            if (error) return;
            tableBody.innerHTML = '';
            let idleCount = 0;

            cars.forEach(car => {
                const lastMove = car.handover && car.handover.length > 0 ? car.handover[car.handover.length - 1] : null;
                const isActive = lastMove && lastMove.event_type === 'Out';
                if (!isActive) idleCount++;

                const driver = isActive ? lastMove.drivers.name : '---';
                const date = isActive ? new Date(lastMove.handover_date).toLocaleDateString('ar-EG') : '---';
                const badge = isActive 
                    ? '<span class="px-4 py-1 bg-green-500 text-white rounded-xl text-[10px] shadow-sm">Ù†Ø´Ø·Ø©</span>'
                    : '<span class="px-4 py-1 bg-red-100 text-red-600 rounded-xl text-[10px]">Ù…ØªÙˆÙ‚ÙØ©</span>';

                tableBody.insertAdjacentHTML('beforeend', `
                    <tr class="border-b border-slate-50 hover:bg-slate-50/80 transition-colors">
                        <td class="p-6">
                            <div class="font-black text-slate-800">${car.plate_no}</div>
                            <div class="text-[10px] text-slate-400 uppercase tracking-tighter">${car.brand}</div>
                        </td>
                        <td class="p-6 text-slate-600">${driver}</td>
                        <td class="p-6 text-slate-500 digital-font text-2xl">${date}</td>
                        <td class="p-6 text-center">${badge}</td>
                    </tr>
                `);
            });
            document.getElementById('idleCars').innerText = idleCount;
        }

        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
