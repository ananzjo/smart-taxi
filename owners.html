<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بيانات المالكين | v2.1.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --sidebar-bg: #0f172a; --accent: #fbbf24; --success: #22c55e; --error: #ef4444; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f1f5f9; margin: 0; }

        /* القائمة الجانبية: ثبات كامل وخطوط مستقيمة */
        .sidebar { width: 280px; background: var(--sidebar-bg); height: 100vh; position: fixed; right: 0; top: 0; color: white; z-index: 1000; border-left: 1px solid rgba(255,255,255,0.05); }
        .main-content { margin-right: 280px; padding: 30px; transition: 0.3s; }
        .nav-link { display: flex; align-items: center; padding: 14px 24px; gap: 12px; color: #94a3b8; transition: 0.2s; font-weight: 700; border-right: 4px solid transparent; text-decoration: none; }
        .nav-link:hover, .nav-link.active { background: #1e293b; color: var(--accent); border-right-color: var(--accent); }

        /* نظام الإشعارات (Notify) */
        #notify { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 12px 25px; border-radius: 12px; font-weight: 900; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; }
        .notify-loading { background: #334155; color: white; border: 1px solid #475569; }
        .notify-success { background: var(--success); color: white; }
        .notify-empty { background: var(--error); color: white; }

        /* التنسيق الموحد للبطاقات (Modal) */
        .modal-container { display: none; position: fixed; inset: 0; z-index: 2000; align-items: center; justify-content: center; padding: 20px; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(5px); }
        .modal-card { background: white; width: 100%; max-width: 600px; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid #e2e8f0; }
        .modal-header { background: var(--sidebar-bg); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        
        /* الحقول المتكيفة */
        .smart-input { width: 100%; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; font-weight: 700; text-align: center; outline: none; transition: 0.3s; }
        @media (min-width: 769px) { .smart-input { padding: 10px; font-size: 0.95rem; } }
        @media (max-width: 768px) { 
            .sidebar { display: none; } .main-content { margin-right: 0; padding: 15px; } 
            .smart-input { padding: 16px; font-size: 1.4rem; } 
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="p-8 text-center border-b border-white/5">
            <h1 class="text-2xl font-black text-yellow-400">التاكسي الذكي</h1>
            <p class="text-[9px] text-slate-500 font-bold tracking-[0.2em] mt-1 uppercase">Version 2.1.1</p>
        </div>
        <nav class="mt-4">
            <a href="cars.html" class="nav-link"><i class="fa-solid fa-car w-6"></i><span>بيانات السيارات</span></a>
            <a href="owners.html" class="nav-link active"><i class="fa-solid fa-user-tie w-6"></i><span>بيانات المالكين</span></a>
            <a href="drivers.html" class="nav-link"><i class="fa-solid fa-id-card w-6"></i><span>بيانات السائقين</span></a>
            <a href="custody.html" class="nav-link"><i class="fa-solid fa-key w-6"></i><span>سجل استلام السيارات</span></a>
            <a href="revenue.html" class="nav-link"><i class="fa-solid fa-coins w-6"></i><span>الإيرادات اليومية</span></a>
            <a href="expenses.html" class="nav-link"><i class="fa-solid fa-tools w-6"></i><span>المصاريف والتشغيل</span></a>
            <a href="payments.html" class="nav-link"><i class="fa-solid fa-money-bill-transfer w-6"></i><span>الدفعات المالية</span></a>
            <a href="reconciliation.html" class="nav-link"><i class="fa-solid fa-chart-pie w-6"></i><span>المطابقة المالية</span></a>
        </nav>
    </aside>

    <div id="notify"></div>

    <main class="main-content">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
            <h2 class="text-3xl font-black text-slate-800">بيانات المالكين</h2>
            <div class="flex gap-3 w-full md:w-auto">
                <button onclick="loadOwners()" class="flex-1 md:flex-none bg-white text-slate-700 border-2 border-slate-200 px-6 py-3 rounded-xl font-bold hover:bg-slate-50 transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-sync"></i> عرض البيانات
                </button>
                <button onclick="openModal()" class="flex-1 md:flex-none bg-slate-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-yellow-500 hover:text-slate-900 transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-plus"></i> إضافة مالك
                </button>
            </div>
        </header>

        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
            <table class="w-full text-center">
                <thead class="bg-slate-50 text-slate-400 text-[11px] font-black uppercase tracking-widest border-b">
                    <tr>
                        <th class="p-5">اسم المالك</th>
                        <th class="p-5">الهاتف</th>
                        <th class="p-5">العنوان</th>
                        <th class="p-5">الرقم الوطني</th>
                        <th class="p-5">الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="ownersTableBody" class="font-bold text-slate-700 divide-y divide-slate-50"></tbody>
            </table>
        </div>
    </main>

    <div id="ownerModal" class="modal-container">
        <div class="modal-card">
            <div class="modal-header">
                <h3 class="font-black text-xl">إدارة بيانات المالك</h3>
                <button onclick="closeModal()" class="text-2xl hover:text-red-400">&times;</button>
            </div>
            <form id="ownerForm" class="p-8 flex flex-col gap-5">
                <input type="hidden" name="id" id="ownerId">
                <div><label class="text-[11px] font-black text-slate-400 mb-1 block">الاسم الكامل</label><input type="text" name="name" required class="smart-input"></div>
                <div><label class="text-[11px] font-black text-slate-400 mb-1 block">رقم الهاتف</label><input type="text" name="phone" required class="smart-input"></div>
                <div><label class="text-[11px] font-black text-slate-400 mb-1 block">العنوان</label><input type="text" name="address" class="smart-input"></div>
                <div><label class="text-[11px] font-black text-slate-400 mb-1 block">الرقم الوطني</label><input type="text" name="national_id" class="smart-input"></div>
                <button type="submit" class="bg-slate-900 text-yellow-400 font-black py-4 rounded-xl mt-4 border-b-4 border-yellow-400 hover:bg-slate-800 transition">تأكيد وحفظ البيانات</button>
            </form>
        </div>
    </div>

    <script>
        // الربط المعتمد مع قاعدة البيانات
        const SUPABASE_URL = 'https://tjntctaapsdynbywdfns.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_BJgdmxyFsCgzFDXh1Qn1CQ_cFRMsy2P';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function showNotify(msg, type) {
            const n = document.getElementById('notify');
            n.innerText = msg; n.className = `notify-${type}`; n.style.display = 'block';
            if (type !== 'loading') setTimeout(() => n.style.display = 'none', 3000);
        }

        function openModal(data = null) {
            document.getElementById('ownerModal').style.display = 'flex';
            if (data) {
                document.getElementById('ownerId').value = data.id;
                document.getElementById('ownerForm').name.value = data.name;
                document.getElementById('ownerForm').phone.value = data.phone;
                document.getElementById('ownerForm').address.value = data.address;
                document.getElementById('ownerForm').national_id.value = data.national_id;
            }
        }

        function closeModal() { 
            document.getElementById('ownerModal').style.display = 'none'; 
            document.getElementById('ownerForm').reset(); 
            document.getElementById('ownerId').value = ''; 
        }

        async function loadOwners() {
            showNotify('جاري جلب البيانات...', 'loading');
            const { data, error } = await supabaseClient.from('owners').select('*').order('created_at', { ascending: false });
            
            if (error) { showNotify('خطأ في الاتصال بالسحابة', 'empty'); return; }
            if (!data || data.length === 0) { showNotify('لا يوجد بيانات حالياً', 'empty'); document.getElementById('ownersTableBody').innerHTML = ''; return; }
            
            showNotify('تم جلب البيانات بنجاح', 'success');
            document.getElementById('ownersTableBody').innerHTML = data.map(o => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-5">${o.name}</td>
                    <td class="p-5">${o.phone}</td>
                    <td class="p-5 text-slate-500">${o.address || '-'}</td>
                    <td class="p-5 font-mono text-slate-400 text-sm">${o.national_id || '-'}</td>
                    <td class="p-5">
                        <button onclick='editOwner(${JSON.stringify(o)})' class="bg-slate-900 text-yellow-400 px-4 py-2 rounded-lg hover:bg-slate-800 transition shadow-md">
                            <i class="fa-solid fa-edit"></i> تعديل
                        </button>
                    </td>
                </tr>`).join('');
        }

        function editOwner(o) { openModal(o); }

        document.getElementById('ownerForm').onsubmit = async (e) => {
            e.preventDefault();
            const fd = Object.fromEntries(new FormData(e.target).entries());
            const id = fd.id; delete fd.id;
            
            showNotify('جاري الحفظ...', 'loading');
            const res = id ? await supabaseClient.from('owners').update(fd).eq('id', id) : await supabaseClient.from('owners').insert([fd]);
            
            if (!res.error) { 
                showNotify('تم الحفظ بنجاح', 'success'); 
                closeModal(); 
                loadOwners(); 
            } else { 
                showNotify('فشل في الحفظ: ' + res.error.message, 'empty'); 
            }
        };

        window.onload = loadOwners;
    </script>
</body>
</html>
